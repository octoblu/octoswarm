#!/bin/bash

build_and_install() {
  local version="$1"
   docker pull "octoblu/octoalpine:latest" \
   && docker pull "octoblu/octoalpine-docker:$version" \
   && build "$version" \
   && install "$version"
}

build() {
  local version="$1"
  docker build -t "local/octoswarm-$version" -f "./Dockerfile-$version" .
}

ensure_whalebrew() {
  local whalebrew_version="0.0.5"
  if [ "$(whalebrew version)" != "Whalebrew $whalebrew_version" ]; then
    curl -L \
      "https://github.com/bfirsh/whalebrew/releases/download/$whalebrew_version/whalebrew-$(uname -s)-$(uname -m)" \
      -o /usr/local/bin/whalebrew && \
      chmod +x /usr/local/bin/whalebrew
  fi  
}

install() {
  local version="$1"
  whalebrew install "local/octoswarm-$version" --force
}

main() {
  ensure_whalebrew
  build_and_install "1.13.1"
  build_and_install "17.03.0-ce"
}

main "$@"
